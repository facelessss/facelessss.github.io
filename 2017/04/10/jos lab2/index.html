<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">

    

    <title>
      jos operation system lab2 | A stupid fish 
    </title>

    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    
      <meta name="author" content="zhoustarr@gmail.com">
    
    

    <meta name="description" content="boot_alloc:
1234result = nextfree;nextfree += ROUNDUP( n , PGSIZE);KADDR(PADDR(nextfree)); //check if npages * pgsizereturn result;
page_init: [IOPHYSMEM, EXTPHYSMEM) and [EXTPHYSMEM,np*pgsize) is not">
<meta property="og:type" content="article">
<meta property="og:title" content="jos operation system lab2 | A stupid fish">
<meta property="og:url" content="http://lfalfa.me/2017/04/10/jos lab2/index.html">
<meta property="og:site_name" content="A stupid fish">
<meta property="og:description" content="boot_alloc:
1234result = nextfree;nextfree += ROUNDUP( n , PGSIZE);KADDR(PADDR(nextfree)); //check if npages * pgsizereturn result;
page_init: [IOPHYSMEM, EXTPHYSMEM) and [EXTPHYSMEM,np*pgsize) is not">
<meta property="og:updated_time" content="2017-04-25T08:27:21.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="jos operation system lab2 | A stupid fish">
<meta name="twitter:description" content="boot_alloc:
1234result = nextfree;nextfree += ROUNDUP( n , PGSIZE);KADDR(PADDR(nextfree)); //check if npages * pgsizereturn result;
page_init: [IOPHYSMEM, EXTPHYSMEM) and [EXTPHYSMEM,np*pgsize) is not">
    
    
    
      <link rel="icon" type="image/x-icon" href="/img/head.png">
    
    <link rel="stylesheet" href="/css/uno.css">
    <link rel="stylesheet" href="/css/highlight.css">
    <link rel="stylesheet" href="/css/archive.css">
    <link rel="stylesheet" href="/css/china-social-icon.css">

</head>
<body>

    <span class="mobile btn-mobile-menu">
        <i class="icon icon-list btn-mobile-menu__icon"></i>
        <i class="icon icon-x-circle btn-mobile-close__icon hidden"></i>
    </span>

    

<header class="panel-cover panel-cover--collapsed">


  <div class="panel-main">

  
    <div class="panel-main__inner panel-inverted">
    <div class="panel-main__content">

        
        <a href="/" title="link to homepage for A stupid fish"><img src="/img/head.png" width="80" alt="A stupid fish logo" class="panel-cover__logo logo" /></a>
        

        <h1 class="panel-cover__title panel-title"><a href="/" title="link to homepage">A stupid fish</a></h1>
        <hr class="panel-cover__divider" />

        

        <div class="navigation-wrapper">

          <nav class="cover-navigation cover-navigation--primary">
            <ul class="navigation">

              
                
                <li class="navigation__item"><a href="/" title="" class="">首页</a></li>
              
                
                <li class="navigation__item"><a href="/#blog" title="" class="blog-button">文章</a></li>
              
                
                <li class="navigation__item"><a href="/archive" title="" class="">归档</a></li>
              

            </ul>
          </nav>

          <!--
To add a new social icon simply duplicate one of the list items from below
and change the class in the <i> tag to match the desired social network
and then add your link to the <a>. Here is a full list of social network
classes that you can use:

    icon-social-500px
    icon-social-behance
    icon-social-delicious
    icon-social-designer-news
    icon-social-deviant-art
    icon-social-digg
    icon-social-dribbble
    icon-social-facebook
    icon-social-flickr
    icon-social-forrst
    icon-social-foursquare
    icon-social-github
    icon-social-google-plus
    icon-social-hi5
    icon-social-instagram
    icon-social-lastfm
    icon-social-linkedin
    icon-social-medium
    icon-social-myspace
    icon-social-path
    icon-social-pinterest
    icon-social-rdio
    icon-social-reddit
    icon-social-skype
    icon-social-spotify
    icon-social-stack-overflow
    icon-social-steam
    icon-social-stumbleupon
    icon-social-treehouse
    icon-social-tumblr
    icon-social-twitter
    icon-social-vimeo
    icon-social-xbox
    icon-social-yelp
    icon-social-youtube
    icon-social-zerply
    icon-mail

-------------------------------->

<!-- add social info here -->



<nav class="cover-navigation navigation--social">
  <ul class="navigation">

    
      <!-- Github -->
      <li class="navigation__item">
        <a href="https://github.com/facelessss" title="GitHub">
          <i class='icon icon-social-github'></i>
          <span class="label">GitHub</span>
        </a>
      </li>
    

    
      <li class="navigation__item">
        <a href="http://zhihu.com/people/zhou-xing-xing-69-98" title="ZhiHu">
          <i class='icon icon-social-zerply'></i>
          <span class="label">ZhiHu</span>
        </a>
      </li>
    

    
        <li class="navigation__item">
          <a href="https://www.reddit.com/user/fasslev" title="Reddit">
            <i class='icon icon-social-reddit'></i>
            <span class="label">Reddit</span>
          </a>
        </li>
    

    
        <li class="navigation__item">
          <a href="https://dribbble.com/facelessju" title="Dribbble">
            <i class='icon icon-social-dribbble'></i>
            <span class="label">Dribbble</span>
          </a>
        </li>
    

    

      <!--
      <li class="navigation__item">
        <a href="" title="">
          <i class='icon cs-icon-weibo'></i>
          <span class="label">Weibo</span>
        </a>
      </li>
        -->



  </ul>
</nav>




        </div>

      </div>

    </div>

    <div class="panel-cover--overlay"></div>
  </div>
</header>

    <div class="content-wrapper">
        <div class="content-wrapper__inner entry">
            

<article class="post-container post-container--single">

  <header class="post-header">
    
    <h1 class="post-title">jos operation system lab2</h1>

    

    <div class="post-meta">
      <time datetime="2017-04-10" class="post-meta__date date">2017-04-10</time> 

      <span class="post-meta__tags tags">

          

          
             &#8226; 标签:
            <font class="tags">
              <a class="tags-link" href="/tags/os-cs/">os cs</a>
            </font>
          

      </span>
    </div>
    
    

  </header>

  <section id="post-content" class="article-content post">
    <p>boot_alloc:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">result = nextfree;</div><div class="line">nextfree += ROUNDUP( n , PGSIZE);</div><div class="line">KADDR(PADDR(nextfree)); <span class="comment">//check if npages * pgsize</span></div><div class="line"><span class="keyword">return</span> result;</div></pre></td></tr></table></figure>
<p>page_init: [IOPHYSMEM, EXTPHYSMEM) and [EXTPHYSMEM,np*pgsize) is not free</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">cprintf(<span class="string">"page init\n"</span>);</div><div class="line"><span class="keyword">size_t</span> i;</div><div class="line"><span class="keyword">for</span> (i = <span class="number">1</span>; i &lt; npages_basemem; i++) &#123;</div><div class="line">pages[i].pp_ref = <span class="number">0</span>;</div><div class="line">pages[i].pp_link = page_free_list;</div><div class="line">page_free_list = &amp;pages[i];</div><div class="line">&#125;</div><div class="line"><span class="keyword">int</span> np = (<span class="keyword">int</span>)ROUNDUP(((<span class="keyword">char</span>*)pages) + (<span class="keyword">sizeof</span>(<span class="keyword">struct</span> Page) * npages) - KERNBASE, PGSIZE)/PGSIZE;</div><div class="line"><span class="keyword">for</span> (i = np; i &lt; npages; i++) &#123;</div><div class="line">pages[i].pp_ref = <span class="number">0</span>;</div><div class="line">pages[i].pp_link = page_free_list;</div><div class="line">page_free_list = &amp;pages[i];</div><div class="line">&#125;</div><div class="line">chunk_list = <span class="literal">NULL</span>;</div></pre></td></tr></table></figure>
<p>page_alloc:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">cprintf(<span class="string">"page alloc\n"</span>);</div><div class="line"><span class="keyword">if</span>( page_free_list == <span class="literal">NULL</span>)&#123;</div><div class="line">	<span class="keyword">return</span> <span class="literal">NULL</span>;</div><div class="line">&#125;</div><div class="line"><span class="keyword">struct</span> Page *p = page_free_list;</div><div class="line">page_free_list = page_free_list-&gt;pp_link;</div><div class="line"><span class="keyword">if</span> (alloc_flags &amp; ALLOC_ZERO) &#123;</div><div class="line">	<span class="built_in">memset</span>(page2kva(p),<span class="string">'\0'</span>,PGSIZE);</div><div class="line">&#125;</div><div class="line"><span class="keyword">return</span> p;</div></pre></td></tr></table></figure>
<p>page_free:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">cprintf(<span class="string">"page free\n"</span>);</div><div class="line"><span class="keyword">if</span>(pp-&gt;pp_ref ==<span class="number">0</span> )&#123;</div><div class="line">	pp-&gt;pp_link = page_free_list;</div><div class="line">	page_free_list = pp;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>free_page_list维护一个空闲物理内存的链表</p>
<p>总空闲空间为npages*PGSIZE</p>
<p>free pages的物理地址实际上是end向上增长的部分，而’end’ is a magic symbol automatically generated by the linker, which points to the end of the kernel’s bss segment。</p>
<h4 id="exercise4"><a href="#exercise4" class="headerlink" title="exercise4"></a>exercise4</h4><p>pgdir_walk:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> pdi = PDX(va);</div><div class="line"><span class="keyword">int</span> pti = PTX(va);</div><div class="line"><span class="keyword">pde_t</span> *pde = &amp;pgdir[pdi]; <span class="comment">//page directory entry(store pa of pt)</span></div><div class="line"><span class="keyword">pte_t</span> *pt = <span class="literal">NULL</span>;         <span class="comment">//page table(the va of pt)</span></div><div class="line"><span class="keyword">if</span>(*pde &amp; PTE_P)&#123;</div><div class="line">	pt = KADDR(PTE_ADDR(*pde));</div><div class="line">&#125;<span class="keyword">else</span>&#123;</div><div class="line">	<span class="keyword">if</span>(create == <span class="number">0</span>)&#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">NULL</span>;</div><div class="line">	&#125;<span class="keyword">else</span>&#123;</div><div class="line">		<span class="keyword">struct</span> Page* page=page_alloc(ALLOC_ZERO);</div><div class="line">		<span class="keyword">if</span>( page == <span class="literal">NULL</span>)&#123;</div><div class="line">			<span class="keyword">return</span> <span class="literal">NULL</span>;</div><div class="line">		&#125;<span class="keyword">else</span>&#123;</div><div class="line">			page-&gt;pp_ref++;</div><div class="line">			pt = (<span class="keyword">pte_t</span>*)page2kva(page);</div><div class="line">			pgdir[pdi] = PADDR(pt) | PTE_P |PTE_W | PTE_U;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">pte_t</span> *pte = &amp;pt[pti];  <span class="comment">//page table entry</span></div><div class="line"><span class="keyword">return</span> pte;</div></pre></td></tr></table></figure>
<p>boot_map_region:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">pte_t</span> *    pte = <span class="literal">NULL</span>;</div><div class="line"></div><div class="line"><span class="keyword">int</span> pn = size / PGSIZE;</div><div class="line"></div><div class="line"><span class="keyword">int</span> i = <span class="number">0</span>;</div><div class="line"><span class="keyword">for</span>(i = <span class="number">0</span>;i &lt; pn;i++)</div><div class="line">&#123;</div><div class="line">	pte = pgdir_walk(pgdir,(<span class="keyword">void</span> *)va,<span class="number">1</span>);</div><div class="line"></div><div class="line">	<span class="keyword">if</span>(!pte)</div><div class="line">	&#123;</div><div class="line">		<span class="keyword">return</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	*pte = pa | perm | PTE_P;</div><div class="line">	va += PGSIZE;</div><div class="line">	pa += PGSIZE;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>page_insert:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">pte_t</span> *pte = pgdir_walk(pgdir, va, <span class="number">1</span>);</div><div class="line"><span class="keyword">if</span>(pte==<span class="literal">NULL</span>)&#123;  <span class="comment">//can't be allocated</span></div><div class="line">	<span class="keyword">return</span> -E_NO_MEM;</div><div class="line">&#125;</div><div class="line"></div><div class="line">pp-&gt;pp_ref++;</div><div class="line"><span class="keyword">if</span>(*pte &amp; PTE_P)&#123;</div><div class="line">	<span class="keyword">if</span>(PTE_ADDR(*pte) == page2pa(pp))&#123;</div><div class="line">		tlb_invalidate(pgdir,va);</div><div class="line">		pp-&gt;pp_ref--;</div><div class="line">	&#125;<span class="keyword">else</span>&#123;</div><div class="line">	page_remove(pgdir,va); <span class="comment">//tlb has been invalidated here</span></div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">*pte = page2pa(pp) | perm | PTE_P;</div><div class="line"><span class="keyword">return</span> <span class="number">0</span>;</div></pre></td></tr></table></figure>
<p>page_lookup:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">pte_t</span>* pte = pgdir_walk(pgdir, va, <span class="number">0</span>);</div><div class="line"><span class="keyword">if</span>(pte == <span class="literal">NULL</span>)&#123;</div><div class="line">	<span class="keyword">return</span> <span class="literal">NULL</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">if</span>(pte_store != <span class="number">0</span>)&#123;</div><div class="line">	*pte_store = pte;</div><div class="line">&#125;</div><div class="line"><span class="keyword">if</span>(*pte &amp; PTE_P)&#123;</div><div class="line">	<span class="keyword">return</span> pa2page(PTE_ADDR(*pte));</div><div class="line">&#125;<span class="keyword">else</span>&#123;</div><div class="line">	<span class="keyword">return</span> <span class="literal">NULL</span>;</div><div class="line">&#125;</div><div class="line"><span class="comment">// Fill this function in</span></div><div class="line"><span class="keyword">return</span> <span class="literal">NULL</span>;</div></pre></td></tr></table></figure>
<p>page_remove:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">pte_t</span>* pte ;</div><div class="line">   <span class="keyword">struct</span> Page* page=page_lookup(pgdir,va,&amp;pte);</div><div class="line">   <span class="keyword">if</span>(page==<span class="literal">NULL</span>)</div><div class="line">   &#123;</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   page_decref(page);</div><div class="line"></div><div class="line">   *pte = <span class="number">0</span>;</div><div class="line">   tlb_invalidate(pgdir,va);</div></pre></td></tr></table></figure>
<p>没什么问题，基本上也是根据check错误解决了一些操作的顺序问题。</p>
<h4 id="exercise5-6"><a href="#exercise5-6" class="headerlink" title="exercise5+6"></a>exercise5+6</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// UPAGES</span></div><div class="line">boot_map_region(kern_pgdir, UPAGES,</div><div class="line">			ROUNDUP(npages*<span class="keyword">sizeof</span>(<span class="keyword">struct</span> Page), PGSIZE),</div><div class="line">			PADDR(pages), PTE_P | PTE_U);</div><div class="line"></div><div class="line"><span class="comment">//kernel stack.</span></div><div class="line">boot_map_region(kern_pgdir,</div><div class="line">            (KSTACKTOP - KSTKSIZE),</div><div class="line">            KSTKSIZE,</div><div class="line">            PADDR(bootstack),</div><div class="line">            (PTE_W | PTE_P));</div><div class="line"><span class="comment">// Map all of physical memory at KERNBASE.</span></div><div class="line"><span class="keyword">uint32_t</span> cr4;</div><div class="line">cr4 = rcr4();</div><div class="line">cr4 |= CR4_PSE;</div><div class="line">lcr4(cr4);</div><div class="line"><span class="comment">//boot_map_region(kern_pgdir, KERNBASE, ~KERNBASE + 1, 0, PTE_W | PTE_P);</span></div><div class="line">boot_map_region_large(kern_pgdir, KERNBASE, (~KERNBASE + <span class="number">1</span>), <span class="number">0</span>,</div><div class="line">			PTE_W | PTE_P | PTE_PS);</div></pre></td></tr></table></figure>
<p>boot_map_region_large:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">pde_t</span> *pde = <span class="literal">NULL</span>;</div><div class="line"></div><div class="line"><span class="keyword">int</span> pn = size / PTSIZE;</div><div class="line"></div><div class="line"><span class="keyword">int</span> i = <span class="number">0</span>;</div><div class="line"><span class="keyword">for</span>(i = <span class="number">0</span>;i &lt; pn;i++)</div><div class="line">&#123;</div><div class="line">	<span class="keyword">int</span> pdi = PDX(va);</div><div class="line">	pgdir[pdi] = pa | perm | PTE_P |PTE_W | PTE_U | PTE_PS;</div><div class="line"></div><div class="line">	va += PTSIZE;</div><div class="line">	pa += PTSIZE;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="challenges"><a href="#challenges" class="headerlink" title="challenges"></a>challenges</h4><p>我在monitor文件中增加了三条命令：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&#123; <span class="string">"showmappings"</span>, <span class="string">"Display in a useful and easy-to-read format all of the physical page mappings"</span> , mon_showmappings&#125;,</div><div class="line">&#123; <span class="string">"setadpgflag"</span>,<span class="string">"set the permissions of any mapping in the current address space"</span>,mon_setadpgflag&#125;,</div><div class="line">&#123; <span class="string">"showcontent"</span>,<span class="string">"show the contents of a range of memory given either a virtual or physical address range"</span>, mon_showcontent&#125;,</div></pre></td></tr></table></figure>
<p>三个函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">int</span></span></div><div class="line"><span class="title">mon_showcontent</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv, <span class="keyword">struct</span> Trapframe *tf)</span>&#123;</div><div class="line">    <span class="keyword">if</span> (argc == <span class="number">1</span>) &#123;</div><div class="line">		cprintf(<span class="string">"Usage: showcontent addr size p/v(0/1)\n"</span>);</div><div class="line">		<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">    <span class="keyword">uint32_t</span> size = xtoi(argv[<span class="number">2</span>]);</div><div class="line">    <span class="keyword">uint32_t</span> pv = xtoi(argv[<span class="number">3</span>]);</div><div class="line">    <span class="keyword">void</span>** addr = (<span class="keyword">void</span>**) xtoi(argv[<span class="number">1</span>]);</div><div class="line"></div><div class="line">    <span class="keyword">int</span> i;</div><div class="line">    <span class="keyword">if</span>( pv == <span class="number">0</span>)&#123;</div><div class="line">        <span class="keyword">void</span>** vaddr = (<span class="keyword">void</span>**)KADDR((<span class="keyword">physaddr_t</span>)addr);</div><div class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; size; ++i)</div><div class="line">    		cprintf(<span class="string">"at physical address %x is %x\n"</span>, addr+i, vaddr[i]);</div><div class="line"></div><div class="line">        <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; size; ++i)</div><div class="line">		cprintf(<span class="string">"at virtual address %x is %x\n"</span>, addr+i, addr[i]);</div><div class="line">	<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span></span></div><div class="line"><span class="title">mon_setadpgflag</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv, <span class="keyword">struct</span> Trapframe *tf)</span>&#123;</div><div class="line">    <span class="keyword">if</span> (argc == <span class="number">1</span>) &#123;</div><div class="line">		cprintf(<span class="string">"Usage: setadpgflag addr intP intW intU (-1 means keeping)\n"</span>);</div><div class="line">		<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">uint32_t</span> addr = xtoi(argv[<span class="number">1</span>]);</div><div class="line">    <span class="keyword">uint32_t</span> P = xtoi(argv[<span class="number">2</span>]);</div><div class="line">    <span class="keyword">uint32_t</span> W = xtoi(argv[<span class="number">3</span>]);</div><div class="line">    <span class="keyword">uint32_t</span> U = xtoi(argv[<span class="number">4</span>]);</div><div class="line">	<span class="keyword">pte_t</span> *pte = pgdir_walk(kern_pgdir, (<span class="keyword">void</span> *)addr, <span class="number">1</span>);</div><div class="line"></div><div class="line">	<span class="keyword">if</span>(P == <span class="number">1</span> ) *pte = *pte | PTE_P;</div><div class="line">    <span class="keyword">if</span>(P == <span class="number">0</span> ) *pte = *pte &amp; (~PTE_P);</div><div class="line">    <span class="keyword">if</span>(W == <span class="number">1</span> ) *pte = *pte | PTE_W;</div><div class="line">    <span class="keyword">if</span>(W == <span class="number">0</span> ) *pte = *pte &amp; (~PTE_W);</div><div class="line">    <span class="keyword">if</span>(U == <span class="number">1</span> ) *pte = *pte | PTE_U;</div><div class="line">    <span class="keyword">if</span>(U == <span class="number">0</span> ) *pte = *pte &amp; (~PTE_U);</div><div class="line"></div><div class="line">	cprintf(<span class="string">"%x : set SUCCESS: "</span>, addr);</div><div class="line">    cprintf(<span class="string">"PTE_P: %x, PTE_W: %x, PTE_U: %x\n"</span>,</div><div class="line">          *pte&amp;PTE_P, *pte&amp;PTE_W, *pte&amp;PTE_U);</div><div class="line">	<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span></span></div><div class="line"><span class="title">mon_showmappings</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv, <span class="keyword">struct</span> Trapframe *tf)</span></div><div class="line">&#123;</div><div class="line">	<span class="keyword">if</span> (argc == <span class="number">1</span>) &#123;</div><div class="line">		cprintf(<span class="string">"Usage: showmappings begin_addr end_addr\n"</span>);</div><div class="line">		<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">int</span> begin = xtoi(argv[<span class="number">1</span>]);</div><div class="line">    <span class="keyword">int</span> end = xtoi(argv[<span class="number">2</span>]);</div><div class="line">	cprintf(<span class="string">"begin: %x, end: %x\n"</span>, begin, end);</div><div class="line">	<span class="keyword">for</span> (; begin &lt;= end; begin += PGSIZE) &#123;</div><div class="line">		<span class="keyword">pte_t</span> *pte = pgdir_walk(kern_pgdir, (<span class="keyword">void</span> *) begin, <span class="number">1</span>);	<span class="comment">//create</span></div><div class="line">		<span class="keyword">if</span> (!pte) panic(<span class="string">"boot_map_region panic, out of memory"</span>);</div><div class="line">		<span class="keyword">if</span> (*pte &amp; PTE_P) &#123;</div><div class="line">			cprintf(<span class="string">"page %x with "</span>, begin);</div><div class="line">            cprintf(<span class="string">"PTE_P: %x, PTE_W: %x, PTE_U: %x\n"</span>,</div><div class="line">		          *pte&amp;PTE_P, *pte&amp;PTE_W, *pte&amp;PTE_U);</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">            cprintf(<span class="string">"page not exist: %x\n"</span>, begin);</div><div class="line">        &#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>最后的着色问题：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">in page: | PPN (20)     	     |    page offset (12) |</div><div class="line">		 -----------------------------------------------</div><div class="line">in cache:| label (18) | set index (9) | line offset(5) |</div></pre></td></tr></table></figure>
<p>所以set index中还有14-12=2个bit可以用来着色：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">struct</span> Page *</span></div><div class="line"><span class="title">page_alloc_with_color</span><span class="params">(<span class="keyword">int</span> alloc_flags, <span class="keyword">int</span> color)</span></div><div class="line">&#123;</div><div class="line">	cprintf(<span class="string">"page alloc\n"</span>);</div><div class="line">	<span class="keyword">if</span>( page_free_list == <span class="literal">NULL</span>)&#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">NULL</span>;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">struct</span> Page *p = page_free_list;</div><div class="line">	<span class="keyword">while</span>(p!=<span class="literal">NULL</span>)&#123;</div><div class="line">		<span class="keyword">if</span>( ( (page2pa(p)&gt;&gt;<span class="number">12</span>) &amp;&amp; <span class="number">0x3</span> ) == color)&#123;</div><div class="line">			<span class="keyword">if</span> (alloc_flags &amp; ALLOC_ZERO) &#123;</div><div class="line">				<span class="built_in">memset</span>(page2kva(p),<span class="string">'\0'</span>,PGSIZE);</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">return</span> p;</div><div class="line">		&#125;</div><div class="line">		p=p-&gt;pp_link;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="literal">NULL</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>

  </section>

  
  

<section class="post-comments">

    <div class="ds-thread" data-thread-key="2017/04/10/jos lab2/"></div>

    <script type="text/javascript">
      var duoshuoQuery = {short_name:"alfalfa"};
      (function() {
        var ds = document.createElement('script');
        ds.type = 'text/javascript';ds.async = true;
        ds.src = '//static.duoshuo.com/embed.js';
        ds.charset = 'UTF-8';
        (document.getElementsByTagName('head')[0] 
        || document.getElementsByTagName('body')[0]).appendChild(ds);
      })();
    </script> 

</section>


</article>


            <footer class="footer">

    <span class="footer__copyright">&copy; 2017-2018. | zhoustarr@gmail.com</span>

</footer>

        </div>
    </div>

    <!-- js files -->
    <script src="/js/jquery.min.js"></script>
    <script src="/js/main.js"></script>
    <script src="/js/scale.fix.js"></script>
    

    

    <script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript"> 
        $(document).ready(function(){
            MathJax.Hub.Config({ 
                tex2jax: {inlineMath: [['[latex]','[/latex]'], ['\\(','\\)']]} 
            });
        });
    </script>


    

    <script src="/js/awesome-toc.min.js"></script>
    <script>
        $(document).ready(function(){
            $.awesome_toc({
                overlay: true,
                contentId: "post-content",
            });
        });
    </script>


    
    
    <!--kill ie6 -->
<!--[if IE 6]>
  <script src="//letskillie6.googlecode.com/svn/trunk/2/zh_CN.js"></script>
<![endif]-->

</body>
</html>
